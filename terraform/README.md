# HackLoad 2025 - Инфраструктура как код

## Обзор

HackLoad 2025 - это хакатон, где команды участников разрабатывают бэкенды систем продажи билетов. Данный репозиторий содержит Terraform инфраструктуру для развертывания комплексной платформы нагрузочного тестирования и мониторинга на Kubernetes для оценки производительности и стабильности решений участников.

## Архитектура

Инфраструктура состоит из следующих компонентов, развернутых на Kubernetes:

- **Веб-приложение для нагрузочного тестирования** - API интерфейс для запуска и управления нагрузочными тестами
- **CloudNativePG** - База данных PostgreSQL для хранения данных приложения и результатов тестов
- **K6 Operator** - Kubernetes-нативное нагрузочное тестирование с K6
- **Prometheus** - Сбор и хранение метрик
- **Grafana** - Визуализация метрик и дашборды

## Структура проекта

```
├── docs/
│   └── adr/                    # Записи архитектурных решений
├── src/                        # Исходный код инфраструктуры
│   ├── modules/                # Terraform модули
│   │   ├── k8s-cluster/       # Настройка Kubernetes кластера
│   │   ├── hackload-app/      # Веб-приложение для нагрузочного тестирования
│   │   ├── cloudnative-pg/    # Развертывание CloudNativePG
│   │   ├── k6-operator/       # Установка K6 оператора
│   │   ├── prometheus/        # Стек мониторинга Prometheus
│   │   └── grafana/           # Визуализация Grafana
│   └── environments/          # Конфигурации окружений
│       ├── dev/
│       ├── staging/
│       └── production/
└── scripts/                   # Утилитарные скрипты
```

## Предварительные требования

- Terraform >= 1.5.0
- kubectl настроенный для вашего Kubernetes кластера
- Helm >= 3.0 (для некоторых chart развертываний)
- Доступ к Kubernetes кластеру (EKS, GKE, AKS или локальному)

## Быстрый старт

1. **Клонирование и навигация**
   ```bash
   git clone <repository-url>
   cd infra/terraform
   ```

2. **Инициализация Terraform**
   ```bash
   terraform init
   ```

3. **Развертывание в среде разработки**
   ```bash
   cd src/environments/dev
   terraform plan
   terraform apply
   ```

## Конфигурация окружений

### Разработка

- Однонодовая база данных
- Минимальное выделение ресурсов
- Базовая настройка мониторинга

### Staging

- Продакшн-подобная настройка с уменьшенными ресурсами
- Полный мониторинг и алертинг
- Нагрузочное тестирование против staging решений участников

### Продакшн

- Высокодоступный PostgreSQL кластер
- Полное выделение ресурсов для нагрузочного тестирования
- Полный мониторинг, алертинг и дашборды

## Процесс нагрузочного тестирования

1. **Регистрация команд**: Команды регистрируют свои бэкенд endpoint'ы через веб-приложение
2. **Конфигурация тестов**: Организаторы настраивают сценарии нагрузочных тестов через API
3. **Выполнение тестов**: K6 оператор запускает распределенные нагрузочные тесты
4. **Сбор метрик**: Prometheus собирает метрики от K6 и целевых систем
5. **Визуализация**: Grafana отображает данные в реальном времени и исторические данные производительности

## Мониторинг и наблюдаемость

- **Метрики приложения**: Кастомные метрики от веб-приложения нагрузочного тестирования
- **Метрики базы данных**: Метрики производительности CloudNativePG и PostgreSQL
- **Метрики нагрузочных тестов**: Метрики производительности тестирования K6
- **Метрики инфраструктуры**: Метрики Kubernetes кластера и узлов
- **Кастомные дашборды**: Предконфигурированные дашборды Grafana для сценариев хакатона

## Соображения безопасности

- Сетевые политики для коммуникации pod-to-pod
- RBAC для сервисных аккаунтов и операторов
- Управление секретами для учетных данных базы данных
- TLS шифрование для межсервисной коммуникации

## Масштабирование

Инфраструктура поддерживает:

- **10-40 команд участников** одновременно
- **Горизонтальное масштабирование** воркеров нагрузочного тестирования
- **Масштабирование базы данных** через read-реплики
- **Хранение метрик** настраиваемое в зависимости от требований

## Оптимизация затрат

- **Лимиты ресурсов**: Все компоненты имеют определенные лимиты ресурсов
- **Автомасштабирование**: Horizontal Pod Autoscalers для переменных нагрузок
- **Хранение**: Настраиваемые политики хранения для метрик и логов
- **Размер окружений**: Различное выделение ресурсов для каждого окружения

## Устранение неполадок

Распространенные проблемы и решения:

1. **Проблемы подключения к базе данных**: Проверьте статус кластера CloudNativePG
2. **Нагрузочные тесты не запускаются**: Проверьте установку K6 оператора и RBAC
3. **Отсутствующие метрики**: Проверьте конфигурацию service discovery Prometheus
4. **Проблемы с дашбордами**: Проверьте конфигурацию источника данных Grafana

## Участие в разработке

1. Следуйте процессу ADR для архитектурных решений
2. Создавайте feature ветки для изменений
3. Тестируйте изменения в среде разработки
4. Обновляйте документацию для новых функций

## Поддержка

По вопросам и проблемам:

- Проверьте раздел устранения неполадок
- Просмотрите существующие ADR в `docs/adr/`
- Создайте issue с подробным описанием

## Лицензия

[Добавьте информацию о лицензии здесь]
