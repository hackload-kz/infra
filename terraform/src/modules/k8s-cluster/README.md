# Модуль Kubernetes кластера

## Обзор

Этот модуль настраивает инфраструктуру Kubernetes кластера, подходящую для размещения платформы нагрузочного тестирования HackLoad 2025. Он предоставляет готовый к продакшну кластер с правильными конфигурациями сети, безопасности и масштабируемости.

## Функции

- **Мульти-узловой кластер** с настраиваемыми пулами узлов
- **Сетевые политики** для безопасного общения между подами
- **Конфигурация RBAC** для сервисных аккаунтов и операторов
- **Квоты ресурсов** и лимиты
- **Конфигурация автомасштабирования**
- **Точки интеграции мониторинга**

## Использование

```hcl
module "k8s_cluster" {
  source = "../../modules/k8s-cluster"
  
  cluster_name     = "hackload-2025"
  environment      = "production"
  node_count       = 3
  node_instance_type = "m5.large"
  
  # Конфигурация сети
  vpc_cidr = "10.0.0.0/16"
  
  # Конфигурация масштабирования
  enable_autoscaling = true
  min_nodes         = 2
  max_nodes         = 10
  
  tags = {
    Project     = "HackLoad2025"
    Environment = "production"
    ManagedBy   = "terraform"
  }
}
```

## Входные параметры

| Имя | Описание | Тип | По умолчанию | Обязательный |
|-----|----------|-----|--------------|-------------|
| cluster_name | Имя Kubernetes кластера | string | - | да |
| environment | Имя окружения (dev/staging/production) | string | - | да |
| node_count | Начальное количество рабочих узлов | number | 3 | нет |
| node_instance_type | Тип EC2 инстанса для рабочих узлов | string | "m5.large" | нет |
| vpc_cidr | CIDR блок для VPC | string | "10.0.0.0/16" | нет |
| enable_autoscaling | Включить автомасштабирование кластера | bool | true | нет |
| min_nodes | Минимальное количество узлов при автомасштабировании | number | 2 | нет |
| max_nodes | Максимальное количество узлов при автомасштабировании | number | 10 | нет |
| tags | Теги ресурсов | map(string) | {} | нет |

## Выходные параметры

| Имя | Описание |
|-----|----------|
| cluster_id | Идентификатор Kubernetes кластера |
| cluster_endpoint | Конечная точка API Kubernetes кластера |
| cluster_security_group_id | ID группы безопасности для кластера |
| node_group_arn | ARN группы узлов |
| cluster_oidc_issuer_url | OIDC issuer URL для кластера |

## Созданные ресурсы

- EKS кластер (или эквивалент для других облачных провайдеров)
- VPC с публичными/приватными подсетями
- Internet Gateway и NAT Gateway
- Группы безопасности
- IAM роли и политики
- Группы узлов с Auto Scaling Groups

## Функции безопасности

- **Изоляция сети**: VPC с приватными подсетями для рабочих узлов
- **RBAC**: Ролевое управление доступом Kubernetes
- **Группы безопасности**: Ограничительные правила сетевого доступа
- **Интеграция IAM**: Интеграция с IAM облачного провайдера
- **Шифрование**: Шифрование в покое и при передаче

## Интеграция мониторинга

- CloudWatch (AWS) или эквивалентный облачный мониторинг
- Сервер метрик Kubernetes
- Node exporter для интеграции с Prometheus
- Метрики автомасштабировщика кластера

## Конфигурация пула узлов

### Пул узлов по умолчанию

- **Назначение**: Общие рабочие нагрузки (веб-приложение, операторы)
- **Тип инстанса**: m5.large (2 vCPU, 8 GB RAM)
- **Масштабирование**: 2-6 узлов

### Пул узлов для нагрузочного тестирования (Опционально)

- **Назначение**: Поды K6 для нагрузочного тестирования
- **Тип инстанса**: c5.xlarge (4 vCPU, 8 GB RAM)
- **Масштабирование**: 0-4 узла (масштабирование до нуля при отсутствии тестирования)

## Оптимизация затрат

- **Spot инстансы**: Опционально для некритичных рабочих нагрузок
- **Правильный размер**: Типы инстансов, оптимизированные для рабочей нагрузки
- **Автомасштабирование**: Уменьшение масштаба в периоды низкого использования
- **Лимиты ресурсов**: Предотвращение растраты ресурсов

## Требования

- Terraform >= 1.5.0
- Настроенный AWS CLI (для EKS)
- kubectl для доступа к кластеру

## Примеры

См. директорию `examples/` для:
- Базовой настройки кластера
- Конфигурации нескольких окружений
- Продвинутой настройки сети

## Устранение неполадок

### Распространенные проблемы

1. **Таймаут создания кластера**
   - Проверьте конфигурацию VPC и подсетей
   - Проверьте права IAM

2. **Узлы не присоединяются к кластеру**
   - Проверьте правила групп безопасности
   - Проверьте конфигурацию группы узлов

3. **Проблемы сетевой связности**
   - Просмотрите таблицы маршрутизации VPC
   - Проверьте конфигурацию NAT gateway

### Полезные команды

```bash
# Получить информацию о кластере
kubectl cluster-info

# Проверить статус узлов
kubectl get nodes

# Просмотреть события кластера
kubectl get events --sort-by=.metadata.creationTimestamp
```

## Заметки по миграции

При обновлении версий кластера:
1. Создайте резервную копию критических данных
2. Протестируйте в staging окружении
3. Следуйте руководствам по обновлению облачного провайдера
4. Обновите группы узлов после control plane

## Связанные модули

- `hackload-app`: Развертывает веб-приложение нагрузочного тестирования
- `prometheus`: Стек мониторинга, который интегрируется с метриками кластера
- `k6-operator`: Требует кластер с определенными правами RBAC
