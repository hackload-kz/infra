# Тестирование функционала смены команды

## Реализованный функционал

### 1. Серверное действие `changeTeam`
- Обрабатывает смену команды участника
- Автоматически удаляет команду, если она остается пустой
- Требует выбора нового лидера, если лидер покидает команду с участниками
- Использует транзакции для обеспечения целостности данных

### 2. Обновленная форма редактирования профиля
- Кнопка "Сменить команду" в разделе команды
- Выбор новой команды из списка доступных
- Опция "Покинуть команду" для выхода без присоединения к новой
- Автоматическое отображение выбора нового лидера для уходящих лидеров

### 3. Логика обработки команд
- **Обычный участник покидает команду**: 
  - Удаляется из команды
  - Если команда остается пустой → удаляется
- **Лидер покидает команду**:
  - Если никого не остается → команда удаляется
  - Если остаются участники → требуется выбор нового лидера
- **Присоединение к новой команде**: простое обновление `teamId`
- **Создание новой команды**: 
  - Создается новая команда с указанными названием и никнеймом
  - Участник автоматически становится лидером новой команды
  - Валидация уникальности никнейма и корректности символов

## Тестовые сценарии

### Сценарий 1: Обычный участник покидает команду
1. Участник (не лидер) заходит в редактирование профиля
2. Нажимает "Сменить команду"
3. Выбирает "Покинуть команду"
4. Подтверждает изменения
5. **Ожидаемый результат**: Участник больше не состоит в команде

### Сценарий 2: Лидер покидает команду с участниками
1. Лидер команды заходит в редактирование профиля
2. Нажимает "Сменить команду"
3. Выбирает "Покинуть команду"
4. Появляется выбор нового лидера из участников команды
5. Выбирает нового лидера и подтверждает
6. **Ожидаемый результат**: Лидерство передано, участник вышел из команды

### Сценарий 3: Единственный участник покидает команду
1. Единственный участник команды заходит в редактирование профиля
2. Нажимает "Сменить команду"
3. Выбирает "Покинуть команду"
4. Подтверждает изменения
5. **Ожидаемый результат**: Участник вышел, команда удалена

### Сценарий 4: Переход в другую команду
1. Участник заходит в редактирование профиля
2. Нажимает "Сменить команду"
3. Выбирает другую команду из списка
4. Если лидер - выбирает нового лидера
5. Подтверждает изменения
6. **Ожидаемый результат**: Участник присоединился к новой команде

### Сценарий 5: Создание новой команды
1. Участник заходит в редактирование профиля
2. Нажимает "Сменить команду"
3. Выбирает "Создать новую команду"
4. Заполняет название и никнейм новой команды
5. Если лидер текущей команды - выбирает нового лидера для старой команды
6. Подтверждает изменения
7. **Ожидаемый результат**: Создана новая команда, участник стал её лидером

### Сценарий 6: Валидация никнейма команды
1. Участник создает новую команду
2. Вводит никнейм с недопустимыми символами (пробелы, спецсимволы)
3. Пытается подтвердить
4. **Ожидаемый результат**: Ошибка валидации, команда не создана

### Сценарий 7: Дублирование никнейма команды
1. Участник создает новую команду
2. Вводит никнейм, который уже существует
3. Пытается подтвердить
4. **Ожидаемый результат**: Ошибка о существующем никнейме

## Технические особенности

### Безопасность
- Только авторизованные пользователи могут менять команды
- Проверка принадлежности к команде при выборе нового лидера
- Транзакции обеспечивают целостность данных

### Обработка ограничений базы данных
- Поле `ledTeamId` имеет уникальное ограничение в схеме Prisma
- При передаче лидерства сначала снимается лидерство с текущего лидера
- Затем назначается новый лидер, избегая конфликтов уникальности
- Правильный порядок операций предотвращает ошибки "Unique constraint failed"
- Исправлено во всех функциях: `leaveTeam`, `createAndJoinTeam`, `joinTeam`

### UI/UX
- Интуитивный интерфейс с четким разделением действий
- Условное отображение выбора лидера только когда необходимо
- Отдельные кнопки для сохранения профиля и смены команды
- Информативные сообщения об ошибках

### Производительность
- Минимальные запросы к базе данных
- Эффективные запросы с include для получения связанных данных
- Правильная ревалидация страниц после изменений